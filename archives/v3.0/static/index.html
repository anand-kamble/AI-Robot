 <!DOCTYPE html>
 <html>
 <head>
     <meta charset='utf-8'>
     <meta http-equiv='X-UA-Compatible' content='IE=edge'>
     <title>AI ROBOTS</title>
     <meta name='viewport' content='width=device-width, initial-scale=1'>
     <script src="socket.io.min.js" integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous"></script>
     <script src="jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
 </head>
 <style>
     html , body{
        font-family: 'Poppins', sans-serif;
         margin: 0%;
         background-color: rgb(10, 10, 10);
         color: whitesmoke;
     }
     .stylediv {
         width: 50px;
         height: 50px;
         background-color: gray;    
         display: flex;
         align-items: center;
         justify-content: center;
     }
     .slider{
         margin: 10vh 0 0 0;
     }
     .keyHolder{
         position: absolute;
            margin-left: 0vw;
         display: grid;
         grid-template-columns: auto auto auto;
         bottom: 10vh;
         margin-left: 10vw;
         transform: translateX(-50%);
     }
     #loginpage {
         position: absolute;
         z-index: 990;
         width: 100vw;
         height: 100vh;
         background-color: rgb(10, 10, 10);
     }
     #introdiv{
         color: whitesmoke;
         width: 50vw;
         background-color: rgb(31, 31, 31);
         margin: 12.5vh 25vw;
         text-align: center;
         height: 70vh;
         padding: 0 0 2.5vh 0;
     }
     .robotname{
         background-color:rgb(49, 49, 49);;
         margin: 2vh 5vw;
         height: 100px;
         border-radius: 10px;
         padding: 5px;
/*          display: flex;
         align-items: center;
         justify-content: center; */

     }
     textarea:focus, input:focus{
    outline: none;
        }
     .authtxt{
         border: none;
         padding: 5px;
         font-family: 'Poppins', sans-serif;
         background-color: rgb(49, 49, 49);
         color: whitesmoke;
         border-bottom: 2px solid whitesmoke;
         width: 20vw;
     }
     ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
        color: whitesmoke;
        opacity: 0.8; /* Firefox */
        }
        .authbtn{
            padding: 10px;
            margin-left: 10px;
            font-family: 'Poppins', sans-serif;
            color: black;
            background-color: whitesmoke;
            border: none;
            border-radius: 5px;
        }
        #IntrotitleHolder{
            position: fixed;
            /* margin-left: 25vw;
            transform: translateX(-50%); */
            background-color:  rgb(31, 31, 31);
            z-index: 991;
            width: 50vw;
        }
        #online-robots{
            display: flex;flex-direction: column;overflow: hidden;margin-top: 100px;
        }
        #alerts{
            color: whitesmoke;
            margin-left: 50vw;
            transform: translateX(-50%);
            position: absolute;
            bottom: 7.5vh;
            display: none;
        }
        #liveimg{
            max-height: 70vh;
            max-width: 50vw;
            margin-left: 50vw;
            transform: translateX(-50%);
        }
        #currentInfo{
            background-color: rgb(10, 10, 10);
            width: 20vw;
            height: 90vh;
            position: absolute;
            padding: 50px 0 0 20px;

        }
        #controls{
            border-left: white 1px solid;
            background-color: rgb(10, 10, 10);
            position: absolute;
            top: 0%;
            right: 0%;
            width: 20vw;
            height: 100vh;
            padding-left: 20px;
        }

        .MobilekeyHolder{
                visibility: hidden;
        }

        @media only screen and (max-width:800px) {
            #controls{
                display: none;
            }

            .MobilekeyHolder{
                visibility: visible;
                display: block;
                z-index: 980;
                margin-top: 90vh;
                position: absolute;
                margin-left: 0vw;
                display: grid;
                grid-template-columns: auto auto auto;
                bottom: 10vh;
                margin-left: 50vw;
                transform: translateX(-50%);
            }
            #currentInfo{
                width: 100vw;
                height: 30vh;
                padding: 3vh;
            }
            #loginpage{
                width:100vw;
            }
            #online-robots{
                width: 100vw;
            }
            #liveimg{
                max-height: 70vh;
                max-width: 100vw;
                margin-top: 30vh;
                margin-left: 50vw;
                transform: translateX(-50%);
            }
            #introdiv{
                margin: 12.5vh 0vw;
                width: 100vw;
            }
            #IntrotitleHolder{
                margin-left: 50vw;
                transform: translateX(-50%);
            }
            .robotname{
                width: 100vw;
            }
        }
 </style>
 <body> 
     <div id="loginpage">
         <p id="alerts">ALERTS</p>
        <div id="introdiv" style="overflow-y: auto;">
            <div id="IntrotitleHolder">
                <h2 id="introhead" >AI Robot</h2>
                <p>Online Robots</p>
            </div>
            <div id="online-robots">
<!--                 <div id="robotname" class="robotname">
                    <p>Robot 1</p>
                    <input type="text" name="auth0" id="auth0" class="authtxt" placeholder="Password">
                    <button type="button" class="authbtn" onclick="">Connect</button>
                </div> -->
            </div>
        </div>
     </div>
     <div id="currentInfo">
        <h1 style="margin-top: 0%;">Robot UI</h1>    
        <p id="connectedto">Connected to : </p>
        <p id="ping">Ping : </p>
<!--         <form class="slider">
            <input type="range" min="1" max="100" value="25" name="speed" id="speed">
        </form>
        <p id="speedprint">Current Speed : 25%</p>
        <p style="display: none;" id="log">Speed Changed success.</p> -->
     </div>
     
     <img id="liveimg" src="https://i.redd.it/adw11ac0plq71.jpg" alt="live footage">

     <div id="controls">
         <h1 style="margin-left: 50%;transform: translateX(-50%);">Controls</h1>
         <p>• To Move forward - <br>press "W" key or Up Arrow Key "↑"</p>
         <p>• To Move Backward - <br>press "S" key or Up Arrow Key "↓"</p>
         <p>• To Move Left - <br>press "A" key or Up Arrow Key "←"</p>
         <p>• To Move Right - <br>press "D" key or Up Arrow Key "→"</p>
         <div class="keyHolder">
            <div class="stylediv" style="background-color: rgb(10, 10, 10);"></div> 
           <div class="stylediv" id="wkey">↑</div>
           <div class="stylediv" style="background-color: rgb(10, 10, 10);"></div>
           <div class="stylediv" id="akey">←</div>
           <div class="stylediv" id="skey">↓</div>
           <div class="stylediv" id="dkey">→</div>
       </div>
     </div>  
     <div class="MobilekeyHolder keyHolder">
        <div class="stylediv" style="background-color: rgb(10, 10, 10);"></div> 
       <div class="stylediv" id="mwkey">↑</div>
       <div class="stylediv" style="background-color: rgb(10, 10, 10);"></div>
       <div class="stylediv" id="makey">←</div>
       <div class="stylediv" id="mskey">↓</div>
       <div class="stylediv" id="mdkey">→</div>
   </div>  


 </body>
 <script>
     var enc = new TextDecoder("utf-8");
     var skt = io()
     $(document).ready(()=>{
        
         skt = io.connect('http://localhost:5000')

         skt.on('connect',()=>{
             
         })
         skt.emit('getOnlineMachines')
     })

     skt.on('sres',(data)=>{
         console.log(`Got ${JSON.stringify(data)}`)
         refreshOnlineRobots(data)  
         
     })
     
     

     function refreshOnlineRobots(data){
        var machines = data.split(',')
        for(i=1;i<machines.length;i++){
            var html = `<div id="robotname"  class="robotname">
                        <p>${machines[i]}</p>
                        <input type="text" name="auth0" id="auth${i}" class="authtxt" placeholder="Password">
                        <button type="button" class="authbtn" onclick="authto('${machines[i]}',${i})">Connect</button>
                    </div>`
            document.getElementById("online-robots").insertAdjacentHTML('beforeend',html)
        } 
     }
     //refreshOnlineRobots(',hi,asf,gdaga,ggad') //1800 202 9898

     function authto(nameofRobot,number){
         console.log(nameofRobot)
         var pass = $("#auth"+number).val();
         var tosend = nameofRobot +','+ pass
         skt.emit("reqtoJoin",tosend)
     }

     skt.on('joinsuccess',(data)=>{
         console.log("VALID RES "+data)
         if(data.includes('joined')){
             console.log('Joined')
             var roomname = data.split(',')[1]
             mainfunc(roomname)
         }
         if(data=='falsePassword'){
             console.log('Pass wrong')
             document.getElementById('alerts').innerText = 'Please check the Password'
             $("#alerts").fadeOut(400,()=>{
                $("#alerts").fadeIn(2000,()=>{})
             })
             
         }
         if(data=='falseName'){
             console.log('name wrong')
         }
     })

     function ping(){
        var startTime = + new Date()
     skt.emit("ping",startTime)
     skt.on('pingres',(data)=>{
         var time = + new Date()
         //console.log(time,startTime)
         var ping = time - startTime
         if(ping > 1000){
             ping = ping/1000
            document.getElementById("ping").innerText = `Ping : ${ping} ms`
         }else{
            document.getElementById("ping").innerText = `Ping : ${ping} ms`
         }
         
     })
     }

     mainfunc()
     function mainfunc(room){
    $("#loginpage").fadeOut()

    setInterval(()=>{
         ping()
     },1000)

     skt.on('takeliveimg',(data)=>{
         //console.log(data)
         var img = enc.decode(data)
         document.getElementById("liveimg").src = 'data:image/jpeg;base64, '+img
     })

        document.getElementById("connectedto").innerText += room
     let keys = {
         w: false,
         a: false,
         s: false,
         d: false
     }
     var wwidth = 50 , awidth = 50 , swidth =50 , dwidth = 50, time = 0;
     // Loops every 33 millisecond
     document.onkeydown = function (e) {   

        //skt.emit('message',"KEY IS DOWN",room)
         //console.log(e.keyCode /* || e.which */);
         if(e.keyCode == 87 || e.keyCode == 38 && keys.w == false){
             //postKeyToServer("w")
             document.getElementById('wkey').style = 'background-color:white;color:black;'
             keys.w = true
             skt.emit('keypress','w',room)
         }
         if(e.keyCode == 65|| e.keyCode == 37 && keys.a == false){
            // postKeyToServer("a")
             document.getElementById('akey').style = 'background-color:white;color:black;'
             keys.a = true
            skt.emit('keypress','a',room)
         }
         if(e.keyCode == 83 || e.keyCode == 40 && keys.s == false){
             //postKeyToServer("s")   
             document.getElementById('skey').style = 'background-color:white;color:black;'
             keys.s = true
             skt.emit('keypress','s',room)
         }
         if(e.keyCode == 68 || e.keyCode == 39 && keys.d == false){
             //postKeyToServer("d")
             document.getElementById('dkey').style = 'background-color:white;color:black;'
             keys.d = true
             skt.emit('keypress','d',room)
         }
     }

     var mwkey = document.getElementById('mwkey')
     var makey = document.getElementById('makey')
     var mskey = document.getElementById('mskey')
     var mdkey = document.getElementById('mdkey')
     mwkey.addEventListener('touchstart',()=>{
         console.log("WM")
         mwkey.style = 'background-color:white;color:black;'
             keys.w = true
             skt.emit('keypress','w',room)
     })
     makey.addEventListener('touchstart',()=>{
        console.log("AM")
        makey.style = 'background-color:white;color:black;'
             keys.a = true
            skt.emit('keypress','a',room)
     })
     mskey.addEventListener('touchstart',()=>{
        console.log("SM")
        mskey.style = 'background-color:white;color:black;'
             keys.s = true
             skt.emit('keypress','s',room)
     })
     mdkey.addEventListener('touchstart',()=>{
        console.log("DM")
        mdkey.style = 'background-color:white;color:black;'
             keys.d = true
             skt.emit('keypress','d',room)
     })

     mwkey.addEventListener('touchend',()=>{
        touchcancel()
     })
     makey.addEventListener('touchend',()=>{
        touchcancel()
     })
     mskey.addEventListener('touchend',()=>{
        touchcancel()
     })
     mdkey.addEventListener('touchend',()=>{
        touchcancel()
     })

     function touchcancel(){
         console.log('Touch Up')
         skt.emit('keyup',room)
/*          $.post("/keyup",(res)=>{
                 console.log(res);
             }) */
        if(!keys.w==false){mwkey.style = 'background-color:gray;color:white;';keys.w = false}
        if(!keys.a==false){makey.style = 'background-color:gray;color:white;';keys.a = false}
        if(!keys.s==false){mskey.style = 'background-color:gray;color:white;';keys.s = false}
        if(!keys.d==false){mdkey.style = 'background-color:gray;color:white;';keys.d = false}   
     }
     document.onkeyup=(e)=>{
         console.log(e.keyCode)
         skt.emit('keyup',room)
/*          $.post("/keyup",(res)=>{
                 console.log(res);
             }) */
        if(!keys.w==false){document.getElementById('wkey').style = 'background-color:gray;color:white;';keys.w = false}
        if(!keys.a==false){document.getElementById('akey').style = 'background-color:gray;color:white;';keys.a = false}
        if(!keys.s==false){document.getElementById('skey').style = 'background-color:gray;color:white;';keys.s = false}
        if(!keys.d==false){document.getElementById('dkey').style = 'background-color:gray;color:white;';keys.d = false}      
     }

     function postKeyToServer(keyCode){
        $.post("/key/"+keyCode,(res)=>{
                 console.log(res);
             })
     }
     var previousSpeed = 25;
     function postSpeedToServer(speed){
        //$("#log").fadeIn(1000,()=>{$("#log").fadeOut(1000)})
        $.post("/changespeed/"+speed , (res)=>{
            if(res == "Done"){
                previousSpeed = speed
                document.getElementById("speedprint").innerText = `Current Speed : ${document.getElementById("speed").value} %`
                document.getElementById("log").innerText = 'Successfully changed the speed.'
                $("#log").fadeIn(1000,()=>{$("#log").fadeOut(1000)})
            }
            if(res == "Failed"){
                document.getElementById("log").value = previousSpeed
                //document.getElementById("speedprint").innerText = `Current Speed : ${document.getElementById("speed").value}%  `
                document.getElementById("log").innerText = 'Failed to change Speed.'
                $("#log").fadeIn(1000,()=>{$("#log").fadeOut(1000)})
            }
        })
     }
/*      setInterval(()=>{
         d = new Date();
            //$("#liveimg").attr("src", "/livefeed?"+d.getTime());
     },1000) */
     //w = 87, a = 65 , s = 83 , d = 68
     // up = 38,left = 37, down = 40, right = 39

     //$("#speed").change(()=>{postSpeedToServer(document.getElementById("speed").value)})
    }
 </script>
 </html>